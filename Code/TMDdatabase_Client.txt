package org.MY_APP.TMD_database;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.MY_APP.Model.Movie;
import org.MY_APP.Model.Director;

import java.io.IOException;
import java.net.URI;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import org.MY_APP.Model.Actor;

// Αυτή η κλάση λειτουργεί ως η "γέφυρα" ανάμεσα στην εφαρμογή και το TMDB.
// Τι κάνει;
// Στέλνει αιτήματα (Requests) στο internet για να ψάξει ταινίες, ηθοποιούς και σκηνοθέτες.
//Λαμβάνει τις απαντήσεις σε μορφή JSON.
//Μετατρέπει αυτές τις απαντήσεις σε αντικείμενα Java (Movie, Actor, Director).

public class TMDdatabase_Client {

    private static final String BASE_URL = "https://api.themoviedb.org/3";  //σταθερή διεύθυνση για το API και φωτογραφίες
    private static final String IMAGE_BASE_URL = "https://image.tmdb.org/t/p/w500";

    private final String apiKey;
    private final HttpClient httpClient;
    private final ObjectMapper objectMapper;

    public TMDdatabase_Client(String apiKey) {
        this.apiKey = apiKey;
        this.httpClient = HttpClient.newHttpClient(); //σύνδεση στο internet
        this.objectMapper = new ObjectMapper();
    }

    // ===================== Αναζήτηση Ταινιών =====================

    public List<Movie> searchMovies(String query) {
        try {
            String encoded = URLEncoder.encode(query, StandardCharsets.UTF_8);
            String url = BASE_URL + "/search/movie?api_key=" + apiKey + "&language=en-US&query=" + encoded + "&page=1&include_adult=false";

            HttpRequest request = HttpRequest.newBuilder().uri(URI.create(url)).GET().build(); //Link της αναζήτησης

            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString()); //Αναμονή απάντησης

            if (response.statusCode() != 200) {
                System.err.println("TMDb search failed with status " + response.statusCode());  //έλεγχος αν πήγαν όλα σωστά
                return List.of();
            }

            TmdbSearchResponse searchResponse = objectMapper.readValue(response.body(), TmdbSearchResponse.class); //μετατροπή JSON σε Java Classes

            List<Movie> movies = new ArrayList<>();
            if (searchResponse.getResults() != null) {
                for (TmdbMovieDTO dto : searchResponse.getResults()) {
                    movies.add(convert(dto));
                }
            }
            return movies;

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return List.of();
        }

    }

    // ===================== Αναζήτηση Ηθοποιού =====================

    public List<Actor> searchActors(String query) {
        try {
            String encoded = URLEncoder.encode(query, StandardCharsets.UTF_8);
            String url = BASE_URL + "/search/person?api_key=" + apiKey + "&language=en-US&query=" + encoded + "&page=1&include_adult=false";

            HttpRequest request = HttpRequest.newBuilder().uri(URI.create(url)).GET().build();

            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            if (response.statusCode() != 200) {
                System.err.println("TMDb actor search failed with status " + response.statusCode());
                return List.of();
            }

            TmdbPersonSearchResponse searchResponse = objectMapper.readValue(response.body(), TmdbPersonSearchResponse.class);

            List<Actor> actors = new ArrayList<>();
            if (searchResponse.results != null) {
                for (TmdbPersonDTO dto : searchResponse.results) {
                    actors.add(convertActorBasic(dto));
                }
            }
            return actors;

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return List.of();
        }
    }

    // ===================== Αναζήτηση Σκηνοθέτη =====================

    public List<Director> searchDirectors(String query) {
        try {
            String encoded = URLEncoder.encode(query, StandardCharsets.UTF_8);
            String url = BASE_URL + "/search/person?api_key=" + apiKey + "&language=en-US&query=" + encoded + "&page=1&include_adult=false";

            HttpRequest request = HttpRequest.newBuilder().uri(URI.create(url)).GET().build();

            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            if (response.statusCode() != 200) {
                System.err.println("TMDb director search failed with status " + response.statusCode());
                return List.of();
            }

            TmdbPersonSearchResponse searchResponse = objectMapper.readValue(response.body(), TmdbPersonSearchResponse.class);

            List<Director> directors = new ArrayList<>();
            if (searchResponse.results != null) {
                for (TmdbPersonDTO dto : searchResponse.results) {
                    // you could filter to only directing department if you add that field
                    directors.add(convertDirectorBasic(dto));
                }
            }
            return directors;

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return List.of();
        }
    }
    // ===================== Λεπτομέρειες Ταινίας =====================

    public Optional<Movie> getMovieDetails(int movieId) {
        try {
            String url = BASE_URL + "/movie/" + movieId + "?api_key=" + apiKey + "&language=en-US";

            HttpRequest request = HttpRequest.newBuilder().uri(URI.create(url)).GET().build();

            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            if (response.statusCode() != 200) {
                System.err.println("TMDb details failed with status " + response.statusCode());
                return Optional.empty();
            }

            TmdbMovieDTO dto = objectMapper.readValue(response.body(), TmdbMovieDTO.class);

            return Optional.of(convert(dto));

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return Optional.empty();
        }
    }

    // ===================== Λεπτομέρειες Ταινίας & Ηθοποιού =====================

    public Optional<Actor> getActorDetails(int actorId) {
        try {
            String url = BASE_URL + "/person/" + actorId + "?api_key=" + apiKey + "&language=en-US";

            HttpRequest request = HttpRequest.newBuilder().uri(URI.create(url)).GET().build();

            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            if (response.statusCode() != 200) {
                System.err.println("TMDb actor details failed with status " + response.statusCode());
                return Optional.empty();
            }

            TmdbPersonDetailsDTO dto =  objectMapper.readValue(response.body(), TmdbPersonDetailsDTO.class);

            Actor actor = new Actor();  //γεμίζει πιο πολλά πεδία όπως φωτογραφία κτλ
            actor.setId(dto.id);
            actor.setName(dto.name);
            actor.setBiography(dto.biography);
            actor.setBirthday(dto.birthday);
            actor.setPopularity(dto.popularity);

            if (dto.profilePath != null) {
                actor.setProfilePath(IMAGE_BASE_URL + dto.profilePath);
            }

            return Optional.of(actor);

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return Optional.empty();
        }
    }

 // ===================== DIRECTOR λεπτομέριες =====================

    public Optional<Director> getDirectorDetails(int directorId) {
        try {
            String url = BASE_URL + "/person/" + directorId +
                    "?api_key=" + apiKey + "&language=en-US";

            HttpRequest request = HttpRequest.newBuilder()
                    .uri(URI.create(url))
                    .GET()
                    .build();

            HttpResponse<String> response =
                    httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            if (response.statusCode() != 200) {
                System.err.println("TMDb director details failed with status " + response.statusCode());
                return Optional.empty();
            }

            TmdbPersonDetailsDTO dto =
                    objectMapper.readValue(response.body(), TmdbPersonDetailsDTO.class);

            Director director = new Director();
            director.setId(dto.id);
            director.setName(dto.name);
            director.setBiography(dto.biography);
            director.setBirthday(dto.birthday);
            director.setPopularity(dto.popularity);

            if (dto.profilePath != null) {
                director.setProfilePath(IMAGE_BASE_URL + dto.profilePath);
            }

            return Optional.of(director);

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
            return Optional.empty();
        }
    }

    // ===================== Helper mapping =====================

    private Movie convert(TmdbMovieDTO dto) {
        Movie movie = new Movie();
        movie.setId(dto.getId());
        movie.setTitle(dto.getTitle());
        movie.setReleaseDate(dto.getReleaseDate());
        movie.setOverview(dto.getOverview());

        if (dto.getPosterPath() != null) {
            movie.setPosterPath(IMAGE_BASE_URL + dto.getPosterPath());
        }

        movie.setPopularity(dto.getPopularity());
        movie.setVoteAverage(dto.getVoteAverage());
        return movie;
    }

    private Actor convertActorBasic(TmdbPersonDTO dto) {
        Actor actor = new Actor();
        actor.setId(dto.id);
        actor.setName(dto.name);

        if (dto.profilePath != null) {
            actor.setProfilePath(IMAGE_BASE_URL + dto.profilePath);
        }

        List<String> knownTitles = new ArrayList<>();
        if (dto.knownFor != null) {
            for (TmdbMovieDTO movie : dto.knownFor) {
                if (movie.getTitle() != null) {
                    knownTitles.add(movie.getTitle());
                }
            }
        }
        actor.setKnownForTitles(knownTitles);

        return actor;
    }

    private Director convertDirectorBasic(TmdbPersonDTO dto) {
        Director director = new Director();
        director.setId(dto.id);
        director.setName(dto.name);

        if (dto.profilePath != null) {
            director.setProfilePath(IMAGE_BASE_URL + dto.profilePath);
        }

        List<String> knownTitles = new ArrayList<>();
        if (dto.knownFor != null) {
            for (TmdbMovieDTO movie : dto.knownFor) {
                if (movie.getTitle() != null) {
                    knownTitles.add(movie.getTitle());
                }
            }
        }
        director.setKnownForTitles(knownTitles);

        return director;
    }

    // ===================== DTO classes (JSON mapping) =====================

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class TmdbSearchResponse {
        @JsonProperty("results")
        private List<TmdbMovieDTO> results;

        public List<TmdbMovieDTO> getResults() {
            return results;
        }

        public void setResults(List<TmdbMovieDTO> results) {
            this.results = results;
        }
    }

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class TmdbMovieDTO {
        @JsonProperty("id")
        private int id;

        @JsonProperty("title")
        private String title;

        @JsonProperty("release_date")
        private String releaseDate;

        @JsonProperty("overview")
        private String overview;

        @JsonProperty("poster_path")
        private String posterPath;

        @JsonProperty("popularity")
        private double popularity;

        @JsonProperty("vote_average")
        private double voteAverage;

        public int getId() {
            return id;
        }

        public void setId(int id) {
            this.id = id;
        }

        public String getTitle() {
            return title;
        }

        public void setTitle(String title) {
            this.title = title;
        }

        public String getReleaseDate() {
            return releaseDate;
        }

        public void setReleaseDate(String releaseDate) {
            this.releaseDate = releaseDate;
        }

        public String getOverview() {
            return overview;
        }

        public void setOverview(String overview) {
            this.overview = overview;
        }

        public String getPosterPath() {
            return posterPath;
        }

        public void setPosterPath(String posterPath) {
            this.posterPath = posterPath;
        }

        public double getPopularity() {
            return popularity;
        }

        public void setPopularity(double popularity) {
            this.popularity = popularity;
        }

        public double getVoteAverage() {
            return voteAverage;
        }

        public void setVoteAverage(double voteAverage) {
            this.voteAverage = voteAverage;
        }


    }



    // ---- People (actors) DTOs ----

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class TmdbPersonSearchResponse {
        @JsonProperty("results")
        public List<TmdbPersonDTO> results;
    }

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class TmdbPersonDTO {
        @JsonProperty("id")
        public int id;

        @JsonProperty("name")
        public String name;

        @JsonProperty("profile_path")
        public String profilePath;

        @JsonProperty("known_for")
        public List<TmdbMovieDTO> knownFor;
    }

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class TmdbPersonDetailsDTO {
        @JsonProperty("id")
        public int id;

        @JsonProperty("name")
        public String name;

        @JsonProperty("profile_path")
        public String profilePath;

        @JsonProperty("biography")
        public String biography;

        @JsonProperty("birthday")
        public String birthday;   // yyyy-MM-dd or null

        @JsonProperty("popularity")
        public double popularity;
    }

    @JsonProperty("known_for_department")
    public String knownForDepartment;

}
